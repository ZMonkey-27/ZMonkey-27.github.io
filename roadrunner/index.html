<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="icon" type="icon/jpg" href="street.jpg">
	<title>Strata Sprint</title>

	<style>
		html, body {
			width: 100%;
			height: 100%;
		}
		body {
			margin: 0;
			padding: 0;
			overflow: hidden;
			user-select: none;
		}
		canvas {
			position: absolute;
			left: 0;
			top: 0;
		}
		img {
			display: none;
		}
	</style>
</head>
<body>
	<canvas id="canvas">Sorry, this game is not supported in this browser.</canvas>

	<img id="car1" src="car-1.png">
	<img id="car2" src="car-2.png">
	<img id="car3" src="car-3.png">
	<img id="car4" src="car-4.png">

	<script>
		window.requestAnimationFrame =
		    window.requestAnimationFrame ||
		    window.mozRequestAnimationFrame ||
		    window.webkitRequestAnimationFrame ||
		    window.msRequestAnimationFrame ||
		    function(cb) {
		    	setTimeout(cb, 17);
		    };
		   var canvas = document.getElementById('canvas'),
		   ctx = canvas.getContext('2d'),
		   cWidth = canvas.width,
		   cHeight = canvas.height,
		   car1 = document.getElementById('car1'),
		   car2 = document.getElementById('car2'),
		   car3 = document.getElementById('car3'),
		   car4 = document.getElementById('car4'),
		   dashLine = 100,
		   dashGap = 100,
		   dashOffset = 3,
		   speed = 1,
		   carSpeed = 3,
		   maxCars = 4,
		   lane1 = [],
		   lane2 = [],
		   lane3 = [],
		   lane1Delay = 0,
		   lane2Delay = 3000,
		   lane3Delay = 5000,
		   gameTimer = 0,
		   speedIncreaseInterval = 0;

		function update() {
			ctx.clearRect(0, 0, cWidth, cHeight);
			resize();
			//Road rectangle
			ctx.beginPath();
			ctx.fillStyle="#343434";
			ctx.fillRect(0, cHeight/10, cWidth, cHeight-cHeight/5);
			ctx.fill();
			//Dashed lines
			ctx.beginPath();
			ctx.setLineDash([dashLine, dashGap]);//20 10
			ctx.lineDashOffset = dashOffset;
			dashOffset+=speed;
			ctx.strokeStyle='#fff';
			ctx.lineWidth=5;
			ctx.moveTo(0, cHeight/2.7);
			ctx.lineTo(cWidth, cHeight/2.7);
			ctx.moveTo(0, cHeight-cHeight/2.7);
			ctx.lineTo(cWidth, cHeight-cHeight/2.7);
			ctx.stroke();
			//Side lines
			ctx.beginPath();
			ctx.setLineDash([]);
			ctx.strokeStyle="yellow";
			ctx.moveTo(0, cHeight/8);
			ctx.lineTo(cWidth, cHeight/8);
			ctx.moveTo(0, cHeight-cHeight/8);
			ctx.lineTo(cWidth, cHeight-cHeight/8);
			ctx.stroke();
			//Cars
			/*ctx.drawImage(car1, 0, cHeight/6, cWidth/6.5, cHeight/8);
			ctx.drawImage(car2, 0, cHeight-cHeight/1.8, cWidth/6.5, cHeight/8);
			ctx.drawImage(car3, 0, cHeight-cHeight/3.5, cWidth/6.5, cHeight/8);*/
			for(var i=0; i< maxCars; i++) {
				var car = lane1[i];
				if(car && car.x < -1*cWidth/6.5) {
					removeItemOnce(lane1, lane1[i]);
					addCar(lane1);
				} else if(car) {
					ctx.drawImage(car.color, car.x, car.y, cWidth/6.5, cHeight/8);
					car.x-=car.speed;
				}
			}
			for(var i=0; i< maxCars; i++) {
				var car = lane2[i];
				if(car && car.x < -1*cWidth/6.5) {
					removeItemOnce(lane2, lane2[i]);
					addCar(lane2);
				} else if(car) {
					ctx.drawImage(car.color, car.x, car.y, cWidth/6.5, cHeight/8);
					car.x-=car.speed;
				}
			}
			for(var i=0; i< maxCars; i++) {
				var car = lane3[i];
				if(car && car.x < -1*cWidth/6.5) {
					removeItemOnce(lane3, lane3[i]);
					addCar(lane3);
				} else if(car) {
					ctx.drawImage(car.color, car.x, car.y, cWidth/6.5, cHeight/8);
					car.x-=car.speed;
				}
			}
			lane1Delay = rand(0, 2000);
		   	lane2Delay = rand(3000, 5000);
		   	lane3Delay = rand(0, 5000);
			gameTimer++;
			if(speedIncreaseInterval > 600) {//3600
				speedIncreaseInterval = 0;
				speed+=1;
				carSpeed+=1;
				console.log('speed increased');
			} else {
				speedIncreaseInterval++;
			}
			requestAnimationFrame(update);
		}

		function start() {
			setTimeout(function() {
				addCar(lane1);
			}, lane1Delay);
			setTimeout(function() {
				addCar(lane2);
			}, lane2Delay);
			setTimeout(function() {
				addCar(lane3);
			}, lane3Delay);
		    update();
		}
		function addCar(lane) {
			switch(lane) {
				case lane1:
					var car = {ctx:ctx, x:cWidth, y:cHeight/6.5, color:randCol(), speed:carSpeed};
					break;
				case lane2:
					var car = {ctx:ctx, x:cWidth, y:cHeight-cHeight/1.8, color:randCol(), speed:carSpeed};
					break;
				case lane3:
					var car = {ctx:ctx, x:cWidth, y:cHeight-cHeight/3.5, color:randCol(), speed:carSpeed};
					break;
			}
		    lane.push(car);
		    console.log('Car added');
		}
		function rand(min, max) {
		    return Math.floor(Math.random() * (max - min + 1) + min);
		}
		function randCol() {
			var colors = [car1, car2, car3, car4];
			return colors[Math.floor(Math.random()*colors.length)];
		}
		function removeItemOnce(arr, value) {
		  var index = arr.indexOf(value);
		  if (index > -1) {
		    arr.splice(index, 1);
		  }
		  console.log('Removed Car');
		  return arr;
		}
		function removeItemAll(arr, value) {
		  var i = 0;
		  while (i < arr.length) {
		    if (arr[i] === value) {
		      arr.splice(i, 1);
		    } else {
		      ++i;
		    }
		  }
		  return arr;
		}
		start();
		function resize() {
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			cWidth = canvas.width;
		   cHeight = canvas.height;
		}
	</script>
</body>
</html>