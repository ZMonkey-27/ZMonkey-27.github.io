<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro|" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools-yui-compressed.js"></script>
    <link href="css/spectrum.css" rel="stylesheet">
    <script src="js/spectrum.js"></script>

    <!--<link href="images/countdown.png" type="icon/png" rel="icon">-->

    <title>Whiteboard</title>
</head>
<body>
<h2>Whiteboard</h2>
            <div id="main">


                <div id="center" style="width:1000px; margin: 0 auto;">


                    <div itemscope itemtype="http://schema.org/WebApplication" id="tool_padding" style="">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">

                        <div id="page">
                            <div id="content">
                              <p style="text-align:center">Whiteboard loading...</p>
                              <p style="text-align:center">Coded by Zane Harrison</p>
                              </div>
                            <div class="footer">
                                <div class="palette-case">
                                    <div class="palette-box">
                                        <div class="palette white eraser"></div>
                                    </div>
                                    <div id="dynamic-palette">
                                        <div class="palette-box">
                                            <div class="palette red"></div>
                                        </div>
                                        <div class="palette-box">
                                            <div class="palette blue"></div>
                                        </div>
                                        <div class="palette-box">
                                            <div class="palette green"></div>
                                        </div>
                                    </div>
                                    <div class="palette-box">
                                        <div class="palette black"></div>
                                    </div>

                                    <div style="clear:both"></div>
                                    <div id="controls-container">
                                        <label for="size">Marker Size:</label>
                                        <input id="size" type="range" min="1" max="10" value="1" onchange="setMarkerSize(this.value)">
                                        <label for="customColor">Custom Marker Color:</label>
                                        <input id="customColor" type="color" onchange="setMarkerColor()"> <!---->
                                    </div>
                                    <div id="btn-container">
                                        <div style="padding-top: 2%;"></div>
                                        <button id="new" class="navbtn">New Canvas</button>
                                        <button id="undo" class="navbtn" onclick="undo()">Undo</button>
                                        <button id="redo" class="navbtn" onclick="redo()">Redo</button>
                                        <!--<button id="download" class="navbtn">Download Picture</button>-->
                                    </div>

                                </div>


                            </div>



                        </div>


                        <iframe id="download_frame" width="1" height="1" style="display:none;">
                        </iframe>



                    </div>

                </div>

                <script>




                            function download() {

                                var canvas = $("#canvas").get(0);
                                var dataUrl = canvas.toDataURL();
                                $.ajax({
                                    type: "POST",
                                    url: "https://toolster.net/instruments/paint_one/convert.php",
                                    data: "base="+dataUrl,
                                    success: function(msg){
                                        //alert(msg);
                                        var iframe = document.getElementById("download_frame");
                                        iframe.src = 'https://toolster.net/instruments/paint_one/download.php?file='+msg;

                                    }
                                });

                            }



                            var ctx, color = "#000";

                            $(document).ready(function () {

                                // setup a new canvas for drawing wait for device init
                                setTimeout(function(){
                                    newCanvas();
                                }, 1000);

                                // reset palette selection (css) and select the clicked color for canvas strokeStyle
                                $(".palette").click(function(){
                                    $(".palette").css("border-color", "#777");
                                    $(".palette").css("border-style", "solid");
                                    $(this).css("border-color", "#fff");
                                    $(this).css("border-style", "dashed");
                                    color = $(this).css("background-color");
                                    ctx.beginPath();
                                    ctx.strokeStyle = color;
                                    setMarkerSize($('#size').val());
                                });

                                $(".eraser").click(function() {
                                    $(".palette").css("border-color", "#777");
                                    $(".palette").css("border-style", "solid");
                                    $(this).css("border-color", "#fff");
                                    $(this).css("border-style", "dashed");
                                    color = $(this).css("background-color");
                                    ctx.beginPath();
                                    ctx.strokeStyle = color;
                                    setMarkerSize(10);
                                });

                                // link the new button with newCanvas() function
                                $("#new").click(function() {
                                    newCanvas();
                                });

                                $("#download").click(function() {
                                    download();
                                });


                            });

                            // function to setup a new canvas for drawing
                            function newCanvas(){
                                //define and resize canvas
                                $("#content").height($(window).height()-90);
                                var canvas = '<canvas id="canvas" width="'+$(window).width()+'" height="'+($(window).height()-90)+'"></canvas>';
                                $("#content").html(canvas);


                                //Получаем размер canvas, для установки цвета фона
                                h=parseInt(document.getElementById("canvas").getAttribute("height"));
                                w=parseInt(document.getElementById("canvas").getAttribute("width"));

                                // setup canvas
                                ctx=document.getElementById("canvas").getContext("2d");
                                ctx.strokeStyle = color;
                                //ctx.lineWidth = 1;
                                ctx.lineWidth = document.getElementById('size').value;
                                ctx.fillStyle = "#fff";
                                ctx.fillRect(0,0,w,h);

                                // setup to trigger drawing on mouse or touch
                                $("#canvas").drawTouch();
                                $("#canvas").drawPointer();
                                $("#canvas").drawMouse();
                            }

                            // prototype to start drawing on touch using canvas moveTo and lineTo
                            $.fn.drawTouch = function() {
                                var start = function(e) {
                                    e = e.originalEvent;
                                    ctx.beginPath();
                                    x = e.changedTouches[0].pageX;
                                    y = e.changedTouches[0].pageY-44;
                                    ctx.moveTo(x,y);
                                };
                                var move = function(e) {
                                    e.preventDefault();
                                    e = e.originalEvent;
                                    x = e.changedTouches[0].pageX;
                                    y = e.changedTouches[0].pageY-44;
                                    ctx.lineTo(x,y);
                                    ctx.stroke();
                                };
                                $(this).on("touchstart", start);
                                $(this).on("touchmove", move);
                            };

                            // prototype to start drawing on pointer(microsoft ie) using canvas moveTo and lineTo
                            $.fn.drawPointer = function() {
                                var start = function(e) {
                                    e = e.originalEvent;
                                    ctx.beginPath();
                                    x = e.pageX;
                                    y = e.pageY-44;
                                    ctx.moveTo(x,y);
                                };
                                var move = function(e) {
                                    e.preventDefault();
                                    e = e.originalEvent;
                                    x = e.pageX;
                                    y = e.pageY-44;
                                    ctx.lineTo(x,y);
                                    ctx.stroke();
                                };
                                $(this).on("MSPointerDown", start);
                                $(this).on("MSPointerMove", move);
                            };

                            // prototype to start drawing on mouse using canvas moveTo and lineTo
                            $.fn.drawMouse = function() {
                                var clicked = 0;
                                var start = function(e) {
                                    clicked = 1;
                                    ctx.beginPath();
                                    x = e.pageX;
                                    y = e.pageY-44;
                                    ctx.moveTo(x,y);
                                    var canvas = document.getElementById("canvas");
                                    cHistory.saveState(canvas);
                                };
                                var move = function(e) {
                                    if(clicked){
                                        x = e.pageX;
                                        y = e.pageY-44;
                                        ctx.lineTo(x,y);
                                        ctx.stroke();
                                    }
                                };
                                var stop = function(e) {
                                    clicked = 0;
                                };
                                $(this).on("mousedown", start);
                                $(this).on("mousemove", move);
                                $(window).on("mouseup", stop);
                            };

                            var cHistory = {
                                redo_list: [],
                                undo_list: [],
                                saveState: function(canvas, list, keep_redo) {
                                  keep_redo = keep_redo || false;
                                  if(!keep_redo) {
                                    this.redo_list = [];
                                  }
                                  
                                  (list || this.undo_list).push(canvas.toDataURL());   
                                },
                                undo: function(canvas, ctx) {
                                  this.restoreState(canvas, ctx, this.undo_list, this.redo_list);
                                },
                                redo: function(canvas, ctx) {
                                  this.restoreState(canvas, ctx, this.redo_list, this.undo_list);
                                },
                                restoreState: function(canvas, ctx,  pop, push) {
                                  if(pop.length) {
                                    this.saveState(canvas, push, true);
                                    var restore_state = pop.pop();
                                    var img = new Element('img', {'src':restore_state});
                                    img.onload = function() {
                                      ctx.clearRect(0, 0, canvas.width, canvas.height);
                                      ctx.drawImage(img, 0, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);  
                                    }
                                  }
                                }
                              }
                              $('undo').on('click', function() {
                                var canvas = document.getElementById("canvas");
                                cHistory.undo(canvas, ctx);
                              });
                              
                              $('redo').on('click', function() {
                                var canvas = document.getElementById("canvas");
                                cHistory.redo(canvas, ctx);
                              });

                            function undo() {
                                var canvas = document.getElementById("canvas");
                                cHistory.undo(canvas, ctx);
                            }

                            function redo() {
                                var canvas = document.getElementById("canvas");
                                cHistory.redo(canvas, ctx);
                            }

                            function setMarkerSize(size) {
                                ctx.lineWidth=size;
                            }

                            function setMarkerColor() {
                                var customColor = $('#customColor').spectrum('get').toHexString();
                                color = customColor;
                                $(".palette").css("border-color", "#777");
                                $(".palette").css("border-style", "solid");
                                var newPalette = document.createElement('div');
                                newPalette.classList.add('palette-box');
                                newPalette.innerHTML="<div class='palette' style='background-color: "+customColor+";border-color: #fff; border-style: dashed;' onclick='$(\".palette\").css(\"border-color\", \"#777\");$(\".palette\").css(\"border-style\", \"solid\");$(this).css(\"border-color\", \"#fff\");$(this).css(\"border-style\", \"dashed\");color = $(this).css(\"background-color\");ctx.beginPath();ctx.strokeStyle = color;'></div>";
                                document.getElementById('dynamic-palette').appendChild(newPalette);
                                document.getElementById('dynamic-palette').children[0].remove();
                                ctx.beginPath();
                                ctx.strokeStyle = color;
                            }

                            $("#customColor").spectrum({
                                color: "hsl(0, 0%, 100%)",
                                flat: false,
                                showInput: true,
                                showAlpha: true,
                                className: "full-spectrum",
                                showButtons: false,
                                showInitial: true,
                                showPalette: true,
                                hideAfterPaletteSelect: true,
                                showSelectionPalette: true,
                                maxSelectionSize: 10,
                                preferredFormat: "hsl",
                                localStorageKey: "spectrum.whiteboard",
                                palette: [
                                    ["rgb(152, 0, 0)", "rgb(255, 0, 0)", "rgb(255, 153, 0)", "rgb(255, 255, 0)", "rgb(0, 255, 0)",
                                        "rgb(0, 255, 255)", "rgb(74, 134, 232)", "rgb(0, 0, 255)", "rgb(153, 0, 255)", "rgb(255, 0, 255)"],
                                    ["rgb(230, 184, 175)", "rgb(244, 204, 204)", "rgb(252, 229, 205)", "rgb(255, 242, 204)", "rgb(217, 234, 211)",
                                        "rgb(208, 224, 227)", "rgb(201, 218, 248)", "rgb(207, 226, 243)", "rgb(217, 210, 233)", "rgb(234, 209, 220)",
                                        "rgb(221, 126, 107)", "rgb(234, 153, 153)", "rgb(249, 203, 156)", "rgb(255, 229, 153)", "rgb(182, 215, 168)",
                                        "rgb(162, 196, 201)", "rgb(164, 194, 244)", "rgb(159, 197, 232)", "rgb(180, 167, 214)", "rgb(213, 166, 189)",
                                        "rgb(204, 65, 37)", "rgb(224, 102, 102)", "rgb(246, 178, 107)", "rgb(255, 217, 102)", "rgb(147, 196, 125)",
                                        "rgb(118, 165, 175)", "rgb(109, 158, 235)", "rgb(111, 168, 220)", "rgb(142, 124, 195)", "rgb(194, 123, 160)",
                                        "rgb(166, 28, 0)", "rgb(204, 0, 0)", "rgb(230, 145, 56)", "rgb(241, 194, 50)", "rgb(106, 168, 79)",
                                        "rgb(69, 129, 142)", "rgb(60, 120, 216)", "rgb(61, 133, 198)", "rgb(103, 78, 167)", "rgb(166, 77, 121)",
                                        "rgb(91, 15, 0)", "rgb(102, 0, 0)", "rgb(120, 63, 4)", "rgb(127, 96, 0)", "rgb(39, 78, 19)",
                                        "rgb(12, 52, 61)", "rgb(28, 69, 135)", "rgb(7, 55, 99)", "rgb(32, 18, 77)", "rgb(76, 17, 48)"]
                                    ]
                                });

                        </script>

                <style>
                    #footer { display: none; }

                    body {
                        /*margin:0px;
                        width:100%;
                        height:100%;
                        overflow:hidden;
                        font-family:Arial;*/
                        /* prevent text selection on ui */
                        user-select: none;
                        -webkit-user-select: none;
                        -moz-user-select: none;
                        -ms-user-select: none;
                        /* prevent scrolling in windows phone */
                        -ms-touch-action: none;
                        /* prevent selection highlight */
                        -webkit-tap-highlight-color: rgba(0,0,0,0);
                        font-family: Calibri, sans-serif;
                    }

                    .header, .footer{
                        position: absolute;
                        background-color: #222;
                        text-align: center;
                    }
                    .header {
                        top: 0px;
                        left: 0px;
                        right: 0px;
                        height: 32px;
                        padding:6px;
                    }
                    .footer {
                        bottom: 0px;
                        left: 0px;
                        right: 0px;
                       /* height: 42px; */
                         padding:2px;


                    }
                    .navbtn {
                        cursor: pointer;
                        float:left;
                        padding: 6px 10px;
                        font-weight: bold;
                        line-height: 18px;
                        font-size: 14px;
                        color: #eee;
                        text-shadow: 0px -1px #000;
                        border: solid 1px #111;
                        border-radius: 4px;
                        background-color: #404040;
                        box-shadow: 0 0 1px 1px #555,inset 0 1px 0 0 #666;
                    }
                    .navbtn-hover, .navbtn:active {
                        color: #222;
                        text-shadow: 0px 1px #aaa;
                        background-color: #aaa;
                        box-shadow: 0 0 1px 1px #444,inset 0 1px 0 0 #ccc;
                    }

                    #content{
                        position: absolute;
                        top: 44px;
                        left: 0px;
                        right: 0px;
                        bottom: 46px;
                        overflow:hidden;
                        /*background-color:#ddd;*/
                    }
                    #canvas{
                        cursor:crosshair ;
                        background-color:#fff;
                    }
                    .palette-case {
                        width:260px;
                        margin:auto;
                        text-align:center;
                    }
                    .palette-box {
                        float:left;
                        padding:2px 6px 2px 6px;
                    }
                    .palette {
                        border:2px solid #777;
                        height:36px;
                        width:36px;
                    }
                    .red{
                        background-color:#c22;
                    }
                    .blue{
                        background-color:#22c;
                    }
                    .green{
                        background-color:#2c2;
                    }
                    .white{
                        background-color:#fff;
                    }
                    .black{
                        background-color:#000;
                        border:2px dashed #fff;
                    }
                    #controls-container {
                        color: #ffffff;
                    }


                    #download { float: right; }

                    #instruct_block
                    {
                        margin: 10px auto 0;
                        width: 50%;
                        color: #ffffff;
                        text-align: left;
                        margin-bottom: 10px;
                    }
                    .module-tabs a {
                        border-bottom: none !important;
                    }
                </style>
            </div>
        </body>
</html>
