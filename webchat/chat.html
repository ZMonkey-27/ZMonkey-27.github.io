<!DOCTYPE html>
<html>
  <head>
    <title>Web Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rtc-lib@0.5.4/dist/bundle/rtc.dep.min.js"></script>
    <link rel="icon" type="icon/ico" href="logo.ico">
    <style>
        body {
          margin: 0;
          padding: 0;
          font-family: "Montserrat", sans-serif;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          background-color: #f9fafc;
          color: #595354;
        }

        .header {
          background-color: #ffffff;
          padding: 10px 40px;
          box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.1);
        }

        .header > .logo-container {
          display: flex;
          align-items: center;
        }

        .header > .logo-container > .logo-img {
          width: 60px;
          height: 60px;
          margin-right: 15px;
        }

        .header > .logo-container > .logo-text {
          font-size: 26px;
          font-weight: 700;
        }

        .header > .logo-container > .logo-text > .logo-highlight {
          color: #65a9e5;
        }
        .main {
            padding: 20px 20px;
        }
        .room-title {
            position: absolute;
            right: 2em;
        }
        video {
          width: 320px;
          height: 240px;
          border: 1px solid #ccc;
          pointer-events: none;
        }
        #userPreview {
            position: absolute;
            right: 2em;
            bottom: 2em;
            display: none;
        }
        #local-settings {
            display: none;
        }
        #guests {
            display: none;
        }
        button {
          background-color: #65a9e5;
          border: none;
          color: white;
          padding: 10px 24px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          cursor: pointer;
          outline: none;
        }
        input {
            border: 1px solid #ccc!important;
            padding: 8px;
            display: inline-block;
            margin: 0;
            outline: none;
        }
    </style>
  </head>
  <body>
    <header class="header">
        <div class="logo-container">
          <img src="logo.ico" alt="Web Chat logo" class="logo-img" />
          <h1 class="logo-text">
            Web<span class="logo-highlight">Chat</span>
          </h1>
          <h2 class="room-title"></h2>
        </div>
    </header>
    <div class="main">
        <div id="setup-container">
            Enter your room key to join:<br>
            <input placeholder="Room key" id="room_key">
            <button id="connectBtn" onclick="preconnect()">Connect</button>
        </div>
        <div id="local-settings">
            <button id="toggleVideo" onclick="stopVideoOnly(document.getElementById('userCamera').srcObject)">Stop Camera</button>
            <button id="toggleMute" onclick="stopAudioOnly(document.getElementById('userCamera').srcObject)">Mute</button>
            <p>When turned back on, you may experience a break in the audiostream. This will not last longer than a second.</p>
            <button id="hangUp" onclick="hangup()">Leave</button>
        </div>
        <div id="guests">
            Guests:<br>
        </div>
         <div id="userPreview">
            You:<br>
            <video id="userCamera" autoplay muted playsinline></video>
        </div>
    </div>

    <script>
        var query = window.location.search;
        var urlParams = new URLSearchParams(query);
        var videoStream = document.getElementById('userCamera').srcObject;
        var camOn = true;
        var muted = false, hasAudio = true;
        var roomId;
        if(urlParams.has('key')) {
            if(urlParams.get('key') !== "false" && urlParams.get('key') !== null && urlParams.get('key') !== "") {
                var roomQuery = urlParams.get('key').replace('wc_', '');
                $('#room_key').val(roomQuery);
                $('#connectBtn').click();
                roomId = roomQuery;
            }
        }
        if(urlParams.has('muted')) {
            if(urlParams.get('muted') !== null && urlParams.get('muted') !== "") {
                muted = urlParams.get('muted');
                hasAudio = (muted === true) ? hasAudio = false : hasAudio = true;
            }
        }
        if(urlParams.has('cam')) {
            if(urlParams.get('cam') !== null && urlParams.get('cam') !== "") {
                camOn = urlParams.get('cam');
            }
        }
        if(urlParams.has('title')) {
            if(urlParams.get('title') !== null && urlParams.get('title') !== "") {
                $('.room-title').text(urlParams.get('title'));
            }
        }
        $('#room_key').on('keypress', function(e) {
            if(e.which === 13) {
                e.preventDefault();
                preconnect();
            }
        });

        /*setInterval(function() {
            var trigger = document.createElement('button');
            trigger.onclick= function(e) {
                $('video').each(function(index) {
                    this.play();
                });
                console.log('Video triggered');
            }
            //trigger.style.display="none";
            trigger.click();
            trigger.remove();
        }, 1000);*/
        function autoplay() {
            var trigger = document.createElement('button');
            trigger.onclick= function(e) {
                $('video').each(function(index) {
                    this.play();
                });
                console.log('Video triggered');
            }
            //trigger.style.display="none";
            trigger.click();
            trigger.remove();
        }

        function toggleVideo() {
            if(camOn === false) {
                camOn = true;
                $('#toggleVideo').text('Camera Off');
                console.log('Camera On');
                changeSettings();
                location.reload();
            } else if(camOn === true) {
                camOn = false;
                $('#toggleVideo').text('Start Camera');
                console.log('Camera Off');
                changeSettings();
            }
        }

        function toggleMute() {
            if(muted === true) {
                muted = false;
                $('#toggleMute').text('Mute');
                changeSettings();
                location.reload();
            } else if(muted === false) {
                muted = true;
                $('#toggleMute').text('Unmute');
                changeSettings();
            }
        }

        function changeSettings() {
            var ifCam = camOn;
            var ifMuted = muted;
            history.pushState('', 'Update Room Settings', '/webchat/chat?key='+roomId+'&muted='+ifMuted+'&cam='+ifCam);
        }

        // both mic and camera
        function stopBothVideoAndAudio(stream) {
            stream.getTracks().forEach(function(track) {
                if (track.readyState == 'live') {
                    track.stop();
                }
            });
        }

        // only camera
        function stopVideoOnly(stream) {
            toggleVideo();
            stream.getTracks().forEach(function(track) {
                if (track.readyState == 'live' && track.kind === 'video') {
                    track.stop();
                }
            });
        }


        // only mic
        function stopAudioOnly(stream) {
            toggleMute();
            stream.getTracks().forEach(function(track) {
                if (track.readyState == 'live' && track.kind === 'audio') {
                    track.stop();
                }
            });
        }

        function hangup() {
            window.location='/webchat/chat';
        }

        function preconnect() {
            if($('#room_key').val() !== "" && $('#room_key').val() !== null) {
                connect();
            } else {
                alert('The room key is required.');
            }
        }
        async function connect() {
          // get room name from input
          const nameInput = $('#room_key');
          const roomKey = "wc_" + nameInput.val();

          if(!urlParams.has('key')) {
            history.pushState('', 'Update Room Key', '/webchat/chat?key='+roomKey);
          }
          
          // make sure we don't connect twice
          nameInput.prop('disabled', true).fadeOut();
          $('#connectBtn').prop('disabled', true).fadeOut();
          $('#setup-container').fadeOut();
          $('#local-settings').fadeIn();
          $('#userPreview').fadeIn();
          $('#guests').fadeIn();

          // connnect to a public signaling server using the given name
          const channel = new rtc.WebSocketChannel("wss://easy.innovailable.eu/" + encodeURI(roomKey));
          const signaling = new rtc.MucSignaling(channel);

          // use a poublic stun server
          const options = {
            stun: "stun:stun.innovailable.eu",
          }

          // create a room
          const room = new rtc.Room(signaling, options);

          try {
              // create a local stream from the users camera
            const stream = await room.local.addStream({ video: camOn, audio: hasAudio });

            // display that stream
            const ve = new rtc.MediaDomElement($('video')[0], stream);
            autoplay();
          } catch(err) {
            alert("Unable to get stream, please give permission. You may need to go into settings if you have denied permissions before.");
            return;
          }

          // get notified whenever we meet a new peer
          room.on('peer_joined', function(peer) {
            // create a video tag for the peer
            const view = $('<video autoplay playsinline>');
            $('#guests').append(view);
            const ve = new rtc.MediaDomElement(view[0], peer);
            autoplay();

            // remove the tag after peer left
            peer.on('left', function() {
              view.remove();
            });
          });

          // join the room
          try {
            await room.connect();
          } catch(err) {
            alert("Unable to join room: " + err.message);
          }
        }
    </script>
  </body>
</html>
